<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <title>–ú–æ–∏ –±–∏–ª–µ—Ç—ã - –õ–æ—Ç–æ</title>

</head>
<body class="bg2">
    <div class="header">

        <a href="/" class="header_bl">
            <img src="{{ url_for('static', filename='img/icons/chevron_left.svg') }}" alt="chevron" >
            <p>–ù–∞–∑–∞–¥</p>
        </a>

        <h1>–ú–æ–∏ –±–∏–ª–µ—Ç—ã</h1>

        
    </div>

    <div class="container">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->

            <div class="filter-status">
                <button class="filter-btn active" data-status="all">–í—Å–µ</button>
                <button class="filter-btn" data-status="winning">–í—ã–∏–≥—Ä—ã—à–Ω—ã–µ</button>
                <button class="filter-btn" data-status="confirmed">–ñ–¥—É—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞</button>
                <button class="filter-btn" data-status="pending">–ñ–¥—É—Ç –≤—ã–±–æ—Ä–∞ —á–∏—Å–µ–ª</button>
                <button class="filter-btn" data-status="completed">–ü—Ä–æ—à–µ–¥—à–∏–µ</button>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º -->
            <div class="filter-draws">
                    <button class="draw-filter-btn active" data-draw="all">
                        <span class="all-icon">–í—Å–µ</span>
                    </button>
                    <!-- –†–æ–∑—ã–≥—Ä—ã—à–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –°—á–µ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="results-counter">
            <h2><span id="visible-tickets-count">0</span> –±–∏–ª–µ—Ç–æ–≤</h2>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–∏–ª–µ—Ç–æ–≤ -->
        <div class="tickets-container" id="tickets-container">
            <!-- –ë–∏–ª–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ JSON -->
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state" id="empty-state">
            <div class="empty-state-icon">üé´</div>
            <h3>–ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∫—É–ø–∏—Ç–µ –ø–µ—Ä–≤—ã–π –±–∏–ª–µ—Ç</p>
            <a href="/" class="btn-primary">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</a>
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loading-state" id="loading-state">
            <div class="loading-spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–ª–µ—Ç–æ–≤...</p>
        </div>
    </div>

    <script>
        class TicketFilter {
            constructor() {
                this.currentStatusFilter = 'all';
                this.currentDrawFilter = 'all';
                this.draws = [];
                this.tickets = [];
                this.processedTickets = [];
                this.init();
            }

            async init() {
                this.showLoading(true);
                try {
                    await this.loadData();
                    this.processTicketsData();
                    this.renderDrawFilters();
                    this.renderTickets();
                    this.bindEvents();
                    this.updateCounter();
                    this.showLoading(false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    this.showError();
                }
            }

            async loadData() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö –∏ –±–∏–ª–µ—Ç–∞—Ö
                    const [drawsResponse, ticketsResponse] = await Promise.all([
                        fetch('/static/data/draws.json'),
                        fetch('/static/data/tickets.json')
                    ]);

                    if (!drawsResponse.ok || !ticketsResponse.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    }

                    this.draws = await drawsResponse.json();
                    this.tickets = await ticketsResponse.json();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ JSON —Ñ–∞–π–ª–æ–≤:', error);
                    throw error;
                }
            }

            processTicketsData() {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–∏–ª–µ—Ç—ã –ø–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º
                const ticketsByDraw = {};
                
                this.tickets.forEach(ticket => {
                    const draw = this.draws.find(d => d.id === ticket.draw_id);
                    if (!draw) return;

                    if (!ticketsByDraw[ticket.draw_id]) {
                        ticketsByDraw[ticket.draw_id] = {
                            drawId: draw.id,
                            drawTitle: draw.title,
                            drawImage: `{{ url_for('static', filename='img/draws/') }}${draw.image}`,
                            drawStatus: this.getDrawStatus(draw),
                            tickets: []
                        };
                    }

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∏–ª–µ—Ç
                    const processedTicket = {
                        id: ticket.ticket_id,
                        numbers: ticket.numbers,
                        status: this.determineTicketStatus(ticket, draw),
                        statusText: this.getStatusText(ticket, draw),
                        purchaseTime: this.formatDateTime(ticket.purchase_time),
                        isPending: ticket.status === 'pending' || ticket.numbers.length === 0
                    };

                    ticketsByDraw[ticket.draw_id].tickets.push(processedTicket);
                });

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤
                this.processedTickets = Object.values(ticketsByDraw);
            }

            determineTicketStatus(ticket, draw) {
                // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–∏–ª–µ—Ç–∞
                if (ticket.status === 'pending' || ticket.numbers.length === 0) {
                    return 'pending';
                }
                
                if (draw.completed) {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–∏–≥—Ä—ã—à–∞
                    // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º–∏
                    return 'completed';
                }
                
                return 'confirmed';
            }

            getStatusText(ticket, draw) {
                const status = this.determineTicketStatus(ticket, draw);
                
                const statusTexts = {
                    'pending': '–ñ–¥–µ—Ç –≤—ã–±–æ—Ä–∞ —á–∏—Å–µ–ª',
                    'confirmed': '–ñ–¥–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞',
                    'winning': '–í—ã–∏–≥—Ä—ã—à–Ω—ã–π!',
                    'completed': '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω'
                };

                return statusTexts[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
            }

            getDrawStatus(draw) {
                if (draw.completed) {
                    return '–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω';
                }
                
                if (draw.time_left) {
                    return `–ê–∫—Ç–∏–≤–Ω—ã–π, –æ—Å—Ç–∞–ª–æ—Å—å: ${draw.time_left}`;
                }
                
                return '–ê–∫—Ç–∏–≤–Ω—ã–π';
            }

            formatDateTime(dateString) {
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${day}.${month}.${year} ${hours}:${minutes}`;
            }

            showLoading(show) {
                const loadingState = document.getElementById('loading-state');
                const container = document.getElementById('tickets-container');
                const emptyState = document.getElementById('empty-state');
                
                if (show) {
                    loadingState.style.display = 'flex';
                    container.style.display = 'none';
                    emptyState.classList.remove('show');
                } else {
                    loadingState.style.display = 'none';
                    container.style.display = 'flex';
                }
            }

            showError() {
                this.showLoading(false);
                const container = document.getElementById('tickets-container');
                container.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –±–∏–ª–µ—Ç–∞—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                        <button onclick="location.reload()" class="btn-primary">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                `;
            }

            renderDrawFilters() {
                const drawFilters = document.querySelector('.filter-draws');
                const allButton = drawFilters.querySelector('[data-draw="all"]');
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∫—Ä–æ–º–µ "–í—Å–µ"
                const existingButtons = drawFilters.querySelectorAll('.draw-filter-btn:not([data-draw="all"])');
                existingButtons.forEach(btn => btn.remove());

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                this.processedTickets.forEach(group => {
                    const button = document.createElement('button');
                    button.className = 'draw-filter-btn';
                    button.setAttribute('data-draw', group.drawId);
                    button.title = group.drawTitle;
                    button.innerHTML = `<img src="${group.drawImage}" alt="${group.drawTitle}">`;
                    drawFilters.appendChild(button);
                });
            }

            renderTickets() {
                const container = document.getElementById('tickets-container');
                container.innerHTML = '';

                this.processedTickets.forEach(group => {
                    const groupEl = this.createTicketGroup(group);
                    container.appendChild(groupEl);
                });
            }

            createTicketGroup(group) {
                const groupEl = document.createElement('div');
                groupEl.className = 'ticket-group';
                groupEl.setAttribute('data-draw-id', group.drawId);

                const ticketsHtml = group.tickets.map(ticket => {
                    const numbersHtml = ticket.isPending 
                        ? '<span class="pending-text">–ß–∏—Å–ª–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</span>'
                        : ticket.numbers.map(num => `<span class="number">${num}</span>`).join('');

                    return `
                        <div class="ticket-item" data-status="${ticket.status}" onclick="goToDrawWithTicket(${group.drawId}, ${ticket.id})">
                            <div class="ticket-numbers">
                                ${numbersHtml}
                            </div>
                            <div class="ticket-info-bottom">
                                <p class="ticket-id">–ë–∏–ª–µ—Ç #${ticket.id}</p>
                                <p class="purchase-time">${ticket.purchaseTime}</p>
                                <p class="ticket-status status-${ticket.status}">${ticket.statusText}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                groupEl.innerHTML = `
                    <div class="ticket-group-header">
                        <img src="${group.drawImage}" alt="${group.drawTitle}" class="draw-icon">
                        <div class="ticket-draw-info">
                            <h3>${group.drawTitle}</h3>
                            <p class="draw-status">${group.drawStatus}</p>
                        </div>
                        <div class="tickets-count"><p>${group.tickets.length} –±–∏–ª–µ—Ç–æ–≤</p></div>
                    </div>
                    <div class="tickets-list">
                        ${ticketsHtml}
                    </div>
                `;

                return groupEl;
            }

            bindEvents() {
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å—Ç–∞—Ç—É—Å–∞
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentStatusFilter = e.target.getAttribute('data-status');
                        this.applyFilters();
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π
                document.querySelectorAll('.draw-filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.draw-filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.closest('.draw-filter-btn').classList.add('active');
                        this.currentDrawFilter = e.target.closest('.draw-filter-btn').getAttribute('data-draw');
                        this.applyFilters();
                    });
                });
            }

            applyFilters() {
                let visibleTicketsCount = 0;
                
                document.querySelectorAll('.ticket-group').forEach(group => {
                    const groupDrawId = group.getAttribute('data-draw-id');
                    let groupVisible = false;
                    
                    // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–∑—ã–≥—Ä—ã—à—É
                    if (this.currentDrawFilter !== 'all' && groupDrawId !== this.currentDrawFilter) {
                        group.classList.add('hidden');
                        return;
                    }

                    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –±–∏–ª–µ—Ç–æ–≤
                    const tickets = group.querySelectorAll('.ticket-item');
                    tickets.forEach(ticket => {
                        const ticketStatus = ticket.getAttribute('data-status');
                        const statusMatch = this.currentStatusFilter === 'all' || ticketStatus === this.currentStatusFilter;
                        
                        if (statusMatch) {
                            ticket.classList.remove('hidden');
                            groupVisible = true;
                            visibleTicketsCount++;
                        } else {
                            ticket.classList.add('hidden');
                        }
                    });

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É
                    if (groupVisible) {
                        group.classList.remove('hidden');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –±–∏–ª–µ—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ
                        const visibleInGroup = group.querySelectorAll('.ticket-item:not(.hidden)').length;
                        const counter = group.querySelector('.tickets-count p');
                        counter.textContent = `${visibleInGroup} –±–∏–ª–µ—Ç–æ–≤`;
                    } else {
                        group.classList.add('hidden');
                    }
                });

                this.updateCounter(visibleTicketsCount);
                this.toggleEmptyState(visibleTicketsCount === 0);
            }

            updateCounter(count) {
                if (count === undefined) {
                    count = document.querySelectorAll('.ticket-item:not(.hidden)').length;
                }
                document.getElementById('visible-tickets-count').textContent = count;
            }

            toggleEmptyState(show) {
                const emptyState = document.getElementById('empty-state');
                const ticketsContainer = document.getElementById('tickets-container');
                
                if (show) {
                    emptyState.classList.add('show');
                    ticketsContainer.style.display = 'none';
                } else {
                    emptyState.classList.remove('show');
                    ticketsContainer.style.display = 'flex';
                }
            }
        }

        function goToDrawWithTicket(drawId, ticketId) {
            // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–æ–∑—ã–≥—Ä—ã—à–∞ —Å –æ—Ç–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–æ–π "–ú–æ–∏ –±–∏–ª–µ—Ç—ã"
            console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É ${drawId}, –±–∏–ª–µ—Ç ${ticketId}`);
            // window.location.href = `/draw/${drawId}?tab=tickets&ticket=${ticketId}`;
            alert(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É ${drawId}, –±–∏–ª–µ—Ç ${ticketId}`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', () => {
            new TicketFilter();
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        window.addEventListener('beforeunload', () => {
            const activeStatusBtn = document.querySelector('.filter-btn.active');
            const activeDrawBtn = document.querySelector('.draw-filter-btn.active');
            
            if (activeStatusBtn && activeDrawBtn) {
                localStorage.setItem('ticketFilters', JSON.stringify({
                    status: activeStatusBtn.getAttribute('data-status'),
                    draw: activeDrawBtn.getAttribute('data-draw')
                }));
            }
        });

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        window.addEventListener('load', () => {
            setTimeout(() => {
                const savedFilters = localStorage.getItem('ticketFilters');
                if (savedFilters) {
                    const filters = JSON.parse(savedFilters);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.getAttribute('data-status') === filters.status);
                    });
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–∞
                    document.querySelectorAll('.draw-filter-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.getAttribute('data-draw') === filters.draw);
                    });
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                    const ticketFilter = window.ticketFilterInstance;
                    if (ticketFilter) {
                        ticketFilter.currentStatusFilter = filters.status;
                        ticketFilter.currentDrawFilter = filters.draw;
                        ticketFilter.applyFilters();
                    }
                }
            }, 100);
        });
    </script>

    <style>
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .error-state p {
            color: #666;
            margin-bottom: 30px;
        }

        .hidden {
            display: none !important;
        }

        .pending-text {
            color: #999;
            font-style: italic;
            padding: 10px;
        }

        .number {
            display: inline-block;
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            margin: 2px;
            font-weight: bold;
        }

        .status-pending { color: #ff9800; }
        .status-confirmed { color: #2196f3; }
        .status-winning { color: #4caf50; font-weight: bold; }
        .status-completed { color: #9e9e9e; }
    </style>
</body>
</html>